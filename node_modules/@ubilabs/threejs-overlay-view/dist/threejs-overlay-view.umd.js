!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three")):"function"==typeof define&&define.amd?define(["three"],t):(e||self).threejsOverlayView=t(e.three)}(this,function(e){function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var r=Math.sin,n=Math.cos,i=Math.pow,a=Math.sqrt,o=Math.atan2,s=Math.asin,l=Math.sign,h=e.MathUtils.degToRad,c=e.MathUtils.radToDeg,u=e.MathUtils.euclideanModulo,d=6371008.8;function v(e,t){var s=e.lat,l=e.lng,c=t.lat,u=t.lng,v=h(c-s),f=h(u-l),p=h(s),g=h(c),y=i(r(v/2),2)+i(r(f/2),2)*n(p)*n(g);return 2*o(a(y),a(1-y))*d}var f=new e.Matrix4;function p(e){return function(){try{return e.apply(void 0,[].slice.call(arguments))}catch(e){throw console.error(e),e}}}return function(){function i(r){this.overlay=void 0,this.camera=void 0,this.renderer=void 0,this.scene=void 0,this.referencePoint=void 0,this.viewportSize=new e.Vector2,this.raycaster=new e.Raycaster,this.onAdd=null,this.onRemove=null,this.update=null,this.referencePoint=t({altitude:0},r),this.overlay=this.initWebGLOverlayView(),this.renderer=null,this.scene=this.initScene(),this.camera=new e.PerspectiveCamera}var a=i.prototype;return a.setMap=function(e){this.overlay.setMap(e)},a.setReferencePoint=function(e){this.referencePoint=t({altitude:0},e)},a.getScene=function(){return this.scene},a.getViewportSize=function(){return this.viewportSize},a.requestRedraw=function(){this.overlay.requestRedraw()},a.raycast=function(e,t,r){void 0===t&&(t=null),void 0===r&&(r={updateMatrix:!0,recursive:!1});var n=r.recursive,i=r.raycasterParameters;r.updateMatrix&&f.copy(this.camera.projectionMatrix).invert(),this.raycaster.ray.origin.set(e.x,e.y,0).applyMatrix4(f),this.raycaster.ray.direction.set(e.x,e.y,.5).applyMatrix4(f).sub(this.raycaster.ray.origin).normalize();var a=this.raycaster.params;i&&(this.raycaster.params=i),null===t&&(t=this.scene,n=!0);var o=Array.isArray(t)?this.raycaster.intersectObjects(t,n):this.raycaster.intersectObject(t,n);return this.raycaster.params=a,o},a.latLngAltToVector3=function(t,r){return void 0===r&&(r=new e.Vector3),function(t,r,n){void 0===n&&(n=new e.Vector3);var i=v(r,{lng:t.lng,lat:r.lat}),a=v(r,{lng:r.lng,lat:t.lat}),o=l(t.lng-r.lng),s=l(t.lat-r.lat),h=t.altitude;return n.set(o*i,s*a,void 0===h?0:h)}(t,this.referencePoint,r)},a.vector3ToLatLngAlt=function(e,t){return void 0===t&&(t={lat:0,lng:0,altitude:0}),function(e,t,i){return void 0===i&&(i={lat:0,lng:0,altitude:0}),function(e,t,i,a){void 0===a&&(a={lat:0,lng:0});var l=h(e.lng),u=h(e.lat),v=h(i),f=t/d,p=s(r(u)*n(f)+n(u)*r(f)*n(v)),g=l+o(r(v)*r(f)*n(u),n(f)-r(u)*r(p));a.lat=c(p),a.lng=c(g)}(t,e.length(),function(e){return u(90-c(o(e.y,e.x)),360)}(e),i),i.altitude=e.z,i}(e,this.referencePoint,t)},a.onContextRestored=function(r){var n=r.gl,i=new e.WebGL1Renderer(t({canvas:n.canvas,context:n},n.getContextAttributes()));i.autoClear=!1,i.autoClearDepth=!1;var a=n.canvas;this.viewportSize.set(a.width,a.height),this.renderer=i},a.onContextLost=function(){this.renderer&&(this.viewportSize.set(0,0),this.renderer.dispose(),this.renderer=null)},a.onDraw=function(e){var t=e.gl,r=e.transformer;if(this.scene&&this.renderer&&null!==this.overlay.getMap()){this.camera.projectionMatrix.fromArray(r.fromLatLngAltitude(this.referencePoint));var n=t.canvas,i=n.width,a=n.height;this.viewportSize.set(i,a),this.renderer.setViewport(0,0,i,a),this.update&&this.update(),this.renderer.render(this.scene,this.camera),this.renderer.resetState()}},a.initScene=function(){var t=new e.Scene,r=new e.HemisphereLight(16777215,4473924,1);r.position.set(0,-.2,1).normalize();var n=new e.DirectionalLight(16777215);return n.position.set(0,10,100),t.add(r,n),t},a.initWebGLOverlayView=function(){var e=this;if(!google||!google.maps)throw new Error("Google Maps API not loaded. Please make sure to create the overlay after the API has been loaded.");if(!google.maps.WebGLOverlayView)throw new Error("WebGLOverlayView not found. Please make sure to load the beta-channel of the Google Maps API.");var t=new google.maps.WebGLOverlayView;return t.onAdd=p(function(){null!==e.onAdd&&e.onAdd()}),t.onRemove=p(function(){null!==e.onRemove&&e.onRemove()}),t.onDraw=p(this.onDraw.bind(this)),t.onContextRestored=p(this.onContextRestored.bind(this)),t.onContextLost=p(this.onContextLost.bind(this)),t},i}()});
//# sourceMappingURL=threejs-overlay-view.umd.js.map
